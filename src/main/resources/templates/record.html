<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Bootstrap Admin Theme</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" th:href="@{vendor/bootstrap/css/bootstrap.min.css}">

    <!-- MetisMenu CSS -->
    <link href="/vendor/metisMenu/metisMenu.min.css" rel="stylesheet" th:href="@{/vendor/metisMenu/metisMenu.min.css}">

    <!-- DataTables CSS -->
    <link href="/vendor/datatables-plugins/dataTables.bootstrap.css" rel="stylesheet" th:href="@{/vendor/datatables-plugins/dataTables.bootstrap.css}">

    <!-- Custom CSS -->
    <link href="/dist/css/sb-admin-2.css" rel="stylesheet" th:href="@{/dist/css/sb-admin-2.css}">

    <!-- Custom Fonts -->
    <link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" th:href="@{/vendor/font-awesome/css/font-awesome.min.css}">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

	<!-- jQuery -->
	<script src="/vendor/jquery/jquery.min.js"
		th:src="@{/vendor/jquery/jquery.min.js}"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="/vendor/bootstrap/js/bootstrap.min.js"
		th:src="@{/vendor/bootstrap/js/bootstrap.min.js}"></script>

	<!-- Metis Menu Plugin JavaScript -->
	<script src="/vendor/metisMenu/metisMenu.min.js"
		th:src="@{/vendor/metisMenu/metisMenu.min.js}"></script>

	<!-- Custom Theme JavaScript -->
	<script src="/dist/js/sb-admin-2.js" th:src="@{/dist/js/sb-admin-2.js}"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.5/lodash.min.js"></script>

	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>
	

	<style type="text/css">
	.is_target {
		background-color: yellow;
	}
	div.tool {
		padding-top : 5px;
	}
	.mission1 {
		background-color: #d0dcef;
	}
	.mission2 {
		background-color: #efd8d0;
	}
	.alchemy {
		background-color: #f7969a;
	}
	.alreadyUsed {
		opacity: 0.4;
	}
	.select2-container--default .select2-results > .select2-results__options {
		max-height: 450px !important;
	}
	#page-wrapper {
		margin-left : 0px;
	}
	</style>

</head>

<body>

	<div id="wrapper">

		<!-- Navigation -->
		<nav class="navbar navbar-default navbar-static-top" role="navigation"
			style="margin-bottom: 0">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="index.html">MHW</a>
			</div>
			<!-- /.navbar-header -->

			<ul class="nav navbar-top-links navbar-right">

			</ul>
			<!-- /.navbar-top-links -->

			<div class="navbar-default sidebar" role="navigation">
				<div class="sidebar-nav navbar-collapse">
					<ul class="nav" id="side-menu">
					</ul>
				</div>
				<!-- /.sidebar-collapse -->
			</div>
			<!-- /.navbar-static-side -->
		</nav>

		<div id="mainApp">
			<div id="page-wrapper">
				<div class="row">
					<div class="col-lg-12">
						<h1 class="page-header">煉金記錄</h1>
					</div>
					<!-- /.col-lg-12 -->
				</div>
				<!-- /.row -->
				<div class="row">
					<div class="col-lg-12">
						<div class="panel panel-default">
							<div class="panel-heading">煉金記錄</div>
							<!-- /.panel-heading -->
							<div class="panel-body">
							
								<div class="alert alert-danger" role="alert">
									<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
									<span class="sr-only">Error:</span>
									<span id="messageLog"></span>
								</div>
								
								<div class="table-responsive">
									<table class="table table-striped table-bordered table-hover">
										<thead>
											<tr>
												<th width="60">#編號</th>
												<th width="60">已通過</th>
												<th>Jewel 1</th>
												<th>Jewel 2</th>
												<th>Jewel 3</th>
												<th>通過種類</th>
												<th width="120">Action</th>
											</tr>
										</thead>
										<tbody>
											<tr is="record-row" 
												v-for="cdata in recordList" 
												:key="cdata.uid" 
												:cdata="cdata"></tr>
										</tbody>
									</table>
								</div>
								<!-- /.table-responsive -->
							</div>
							<!-- /.panel-body -->
							<div class="panel-footer">
								<div>
									<button class="btn btn-primary" v-on:click="doAdd()">新增記錄</button>
									<button class="btn btn-success" v-on:click="doPass()" style="position: fixed;top:60px;left:20px;">任務通過</button>
								</div>
							</div>
						</div>
						<!-- /.panel -->
					</div>
					<!-- /.col-lg-12 -->
				</div>
				<!-- /.row -->
			</div>
			<!-- /#page-wrapper -->
		</div>

	</div>
	<!-- /#wrapper -->

	<script type="text/javascript" th:inline="javascript">
	var contextPath = /*[[@{/}]]*/ '';
	if(contextPath.length > 0 && _.endsWith(contextPath, '/')) {
		contextPath = contextPath.substring(0, contextPath.length -1);
	}
	</script>

	<script type="text/javascript">
	var mainApp;
	var usedTypeMap;
	var jewelOptions, jewelRawData;
	
	$(function() {
		// load option data
		$.ajax({
			dataType : "json",
			url : contextPath + "/api/option/jewel",
			success : function(resp) {
				jewelRawData = resp;
				jewelOptions = [];
				jewelOptions.push({
					id : "0",
					text : '-- 無 --'
				});
				_.each(resp, function(item) {
					jewelOptions.push({
						id : item.uid,
						text : 'R' + item.rare + '-' + item.name + '-S' + item.socket
					})
				});
			}
		});

		$.ajax({
			dataType : "json",
			url : contextPath + "/api/option/usedType",
			success : function(resp) {
				usedTypeMap = resp;
			}
		});

		// 
		var initMainApp = function() {
			// Vue
			mainApp = new Vue({
				el : '#mainApp',
				data : {
					recordList : []
				},
				mounted : function() {
					this.$nextTick(function() {
						this.hideErrorMessage();
					});
				},
				methods : {
					doPass : function() {
						var lastPass = _.findLast(this.recordList, function(record) {
							return record.isUsed === true;
						});
						var toUpdateSn = 1;
						if(lastPass) {
							toUpdateSn = lastPass.sn + 1;
						}
						this.toUsed(toUpdateSn);
					},
					toUsed : function(sn) {
						var toUpdate = _.find(this.recordList, function(record) {
							return record.sn == sn;
						});
						if(!toUpdate) {
							this.showErrorMessage('找不到 toUpdate ' + sn);
							return;
						}
						toUpdate.isUsed = true;
						if(toUpdate.usedType == 'Mission2') {
							this.toUsedIfMission2(toUpdate.sn + 1);
						}
					},
					toUsedIfMission2 : function(sn) {
						var toUpdate = _.find(this.recordList, function(record) {
							return record.sn == sn;
						});
						if(!toUpdate) {
							this.showErrorMessage('找不到 toUpdate ' + sn);
							return;
						}
						if(toUpdate.usedType == 'Mission2') {
							toUpdate.isUsed = true;
						}
					},
					clearUsedType : function(fromSn) {
						var self = this;
						_.each(this.recordList, function(record, index) {
							if(record.sn < fromSn) {
								return;
							}
							record.usedType = "0";
						});
					},
					assignUsedType : function(fromSn) {
						this.hideErrorMessage();
						var self = this;
						_.each(this.recordList, function(record, index) {
							if(record.sn < fromSn) {
								return;
							}
							var usedType = self.assumeUsedType(record.sn);
							if(usedType == null) {
								return;
							}
							record.usedType = usedType;
						});
					},
					assumeUsedType : function(sn) {
						var lastTwo = this.lastTwoUsedType(sn);
						if(lastTwo.length < 2) {
							this.showErrorMessage('無法執行');
							return null;
						}
						var nextType;
						var first = lastTwo[0], second = lastTwo[1];
						if(first == second) {
							if(first == 'Mission1') {
								nextType = 'Mission2';
							}else if(first == 'Mission2') {
								nextType = 'Mission1'
							}
						}else {
							if(first == 'Mission1') {
								nextType = 'Mission1';
							}else if(first == 'Mission2') {
								nextType = 'Mission2'
							}
						}
						console.log('nextType', nextType);
						return nextType;
					},
					lastTwoUsedType : function(sn) {
						var m = [];
						var last10 = [];
						last10 = _.filter(this.recordList, function(record) {
							return record.sn < sn && last10.length < 10;
						});
						_.eachRight(last10, function(record, index) {
							if(m.length >= 2) {
								return;
							}
							var usedType = record.usedType;
							if(_.startsWith(usedType, 'Mission')) {
								m.push(usedType);
							}
						});
						return m;
					},
					doAdd : function() {
						var data = new RecordModel();
						var self = this;
						$.ajax({
							type : 'POST',
							url : contextPath + "/api/record/add",
							data : JSON.stringify(data),
							contentType : 'application/json',
							viewModel : self,
							success : function(resp) {
								this.viewModel.recordList.push(new RecordModel(resp));
							}
						});
					},
					reload : function() {
						var self = this;
						$.ajax({
							url : contextPath + "/api/record",
							data : {},
							contentType : 'application/json',
							beforeSend : function() {
								
							},
							success : function(resp) {
								_.each(resp, function(item) {
									var model = new RecordModel(item);
									var cloneJewelOption = _.clone(jewelOptions);
									model.jewelData1 = _.find(cloneJewelOption, function(jewel) {
										return jewel.id == model.jewel1;
									});
									model.jewelData2 = _.find(cloneJewelOption, function(jewel) {
										return jewel.id == model.jewel2;
									});
									model.jewelData3 = _.find(cloneJewelOption, function(jewel) {
										return jewel.id == model.jewel3;
									});
									self.recordList.push(model);
								})
							},
							complete : function() {
								$.unblockUI();
							}
						});
					},
					firstCall : function() {
						this.reload();
					},
					showErrorMessage : function(msg) {
						$('#messageLog').html(msg).parent().show();
					},
					hideErrorMessage : function() {
						$('#messageLog').html('').parent().hide();
					}
				}
			});
			mainApp.firstCall();
		}

		$.blockUI();
		_.delay(function() {
			initMainApp();
		}, 800);
 	});
	
	// record model
	function RecordModel(data) {
		var exdata = $.extend({}, data);
		this.uid = exdata.uid || "";
		this.sn = exdata.sn;
		this.jewel1 = exdata.jewel1;
		this.jewel2 = exdata.jewel2;
		this.jewel3 = exdata.jewel3;
		this.targetIndex = exdata.targetIndex;
		this.isUsed = exdata.isUsed || false;
		this.usedType = exdata.usedType;
		this.jewelData1 = null;
		this.jewelData2 = null;
		this.jewelData3 = null;

	}
    </script>
    
    <!-- template -->
    <script type="text/x-template" id="recordRowTemplate">
	<tr v-bind:class="{'alreadyUsed' : cdata.isUsed}">
		<td>{{snText}}</td>
		<td class="text-center">
			<input type="checkbox" v-model="cdata.isUsed"/>
		</td>
		<td v-bind:class="{'is_target' : hasTarget1}">
			<div>
			<div>
				<select v-jewel-select="cdata.jewelData1"></select>
			</div>
			<div class="tool">
				<button type="button" class="btn btn-xs btn-primary" @click="addTarget('1')" v-show="hasTarget1 == false">設定目標</button>
				<button type="button" class="btn btn-xs btn-danger" @click="removeTarget('1')" v-show="hasTarget1">移除目標</button>
			</div>
			</div>
		</td>
		<td v-bind:class="{'is_target' : hasTarget2}">
			<div>
			<div>
				<select v-jewel-select="cdata.jewelData2"></select>
			</div>
			<div class="tool">
				<button type="button" class="btn btn-xs btn-primary" @click="addTarget('2')" v-show="hasTarget2 == false">設定目標</button>
				<button type="button" class="btn btn-xs btn-danger" @click="removeTarget('2')" v-show="hasTarget2">移除目標</button>
			</div>
			</div>
		</td>
		<td v-bind:class="{'is_target' : hasTarget3}">
			<div>
			<div>
				<select v-jewel-select="cdata.jewelData3"></select>
			</div>
			<div class="tool">
				<button type="button" class="btn btn-xs btn-primary" @click="addTarget('3')" v-show="hasTarget3 == false">設定目標</button>
				<button type="button" class="btn btn-xs btn-danger" @click="removeTarget('3')" v-show="hasTarget3">移除目標</button>
			</div>
			</div>
		</td>
		<td v-bind:class="{'mission1' : cdata.usedType == 'Mission1', 'mission2' : cdata.usedType == 'Mission2', 'alchemy' : cdata.usedType == 'Alchemy'}">
			<select v-used-type-select="cdata.usedType"></select>
		</td>
		<td>
			<button type="button" class="btn btn-default" @click="autoAssign()">自動安排通過種類</button>
			<button type="button" class="btn btn-default" @click="clearAssign()">清除以下通過種類</button>
		</td>
	</tr>
	</script>
	<script type="text/javascript">
	Vue.component('record-row', {
		template: '#recordRowTemplate',
		props : {
			cdata : Object
		},
		data: function () {
			return {
				targetJewel : []
			};
		},
		mounted : function() {
			var targetIndexValue = this.cdata.targetIndex;
			targetIndexValue = _.defaultTo(targetIndexValue, '');
			this.targetJewel = _.split(targetIndexValue, ",");
		},
		watch : {
			'cdata' : {
				handler : function(value, oldValue) {
					this.save();
				},
				deep : true
			},
			'cdata.jewelData1' : function(value, oldValue) {
				var newUid = _.get(value, 'id');
				this.changeJewelUid('jewel1', newUid);
			},
			'cdata.jewelData2' : function(value, oldValue) {
				var newUid = _.get(value, 'id');
				this.changeJewelUid('jewel2', newUid);
			},
			'cdata.jewelData3' : function(value, oldValue) {
				var newUid = _.get(value, 'id');
				this.changeJewelUid('jewel3', newUid);
			},
			'targetJewel' : function(value, oldValue) {
				var d = _.filter(value, function(val) {
					return val != '' && value.length > 0;
				});
				this.cdata.targetIndex = d.join(',');
			}
		},
		computed : {
			snText : function() {
				var sn = _.get(this, 'cdata.sn');
				if(sn) {
					return '#' + sn;
				}
				return '--';
			},
			hasTarget1 : function() {
				return this.isTarget('1');
			},
			hasTarget2 : function() {
				return this.isTarget('2');
			},
			hasTarget3 : function() {
				return this.isTarget('3');
			},
			hasAnyTarget : function() {
				return this.targetJewel.length > 0;
			}
		},
		methods : {
			addTarget : function(target) {
				if(this.targetJewel.indexOf(target) == -1) {
					this.targetJewel.push(target);
				}
			},
			removeTarget : function(target) {
				this.targetJewel = _.remove(this.targetJewel, function(item) {
					return item != target;
				});
			},
			isTarget : function(target) {
				return _.indexOf(this.targetJewel, target) != -1;
			},
			save : function() {
				$.ajax({
					type : 'POST',
					url : contextPath + '/api/record/update',
					data : JSON.stringify(this.cdata),
					contentType : 'application/json',
					success : function(resp) {
						var uid = _.get(resp, 'uid');
						if(uid == null) {
							alert('儲存失敗')
						}
					}
				});
			},
			autoAssign : function() {
				var fromSn = this.cdata.sn;
				this.$parent.assignUsedType(fromSn);
			},
			clearAssign : function() {
				var fromSn = this.cdata.sn;
				this.$parent.clearUsedType(fromSn);
			},
			changeJewelUid : function(propName, value) {
				var oldValue = _.get(this.cdata, propName);
				if(oldValue == value) {
					return;
				}
				_.set(this.cdata, propName, value);
			}
		}
	});
	</script>
	
	<!-- directive -->
	<script type="text/javascript">
	Vue.directive('jewel-select', {
		bind : function(el, binding, vnode) {
			var $el = $(el);
			vnode.context.$nextTick(function() {
				var selectedValue = _.get(vnode.context, binding.expression);
				var selectedUid = _.get(selectedValue, "id");
				selectedUid = _.defaultTo(selectedUid, "0");
				var optionData = _.clone(jewelOptions);
				$el.select2({
					data : optionData,
					width : '100%'
				}).on('select2:select', function(e) {
					var selectedValue = e.params.data;
					_.set(vnode.context, binding.expression, selectedValue);
				});
				$el.val(selectedUid).trigger('change');
			});
		},
		update : function() {
		}
	});
	Vue.directive('used-type-select', {
		bind : function(el, binding, vnode) {
			var $el = $(el);
			vnode.context.$nextTick(function() {
				var value = _.get(vnode.context, binding.expression);
				value = _.defaultTo(value, "0");
				var optionData = [];
				optionData.push({
					id : "0",
					text : '----'
				});
				for(var key in usedTypeMap) {
					optionData.push({
						id : key,
						text : usedTypeMap[key].text
					});
				}
				 
				$el.select2({
					data : optionData,
					width : '100%'
				}).on('select2:select', function(e) {
					var selectedValue = e.params.data;
					_.set(vnode.context, binding.expression, selectedValue.id);
				});
				$el.val(value).trigger('change');
			});	
		},
		update : function(el, binding, vnode) {
			var val = _.defaultTo(binding.value, '0');
			$(el).val(val).trigger('change');
		}
	});
	</script>
</body>

</html>
